
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DorDor Admin (Password Login)</title>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;background:#0a0a0a;color:#e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#111315;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:16px}
    input,button{height:36px;border-radius:10px;border:1px solid #1f242a;background:#0f1113;color:#e5e7eb;padding:0 10px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    .muted{color:#9ca3af}
    .row{display:flex;gap:8px;flex-wrap:wrap}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>DorDor Admin（密码登录版）</h1>
    <p class="muted">无需 SMTP，直接使用邮箱+密码登录；仅当 profile.role='admin' 时显示管理界面。</p>

    <div id="auth" class="card">
      <div class="row">
        <input id="supabaseUrl" placeholder="SUPABASE_URL（Settings → API → Project URL）" style="min-width:360px" />
        <input id="supabaseAnon" placeholder="SUPABASE_ANON_KEY（Settings → API → anon public）" style="min-width:420px" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="email" placeholder="管理员邮箱" style="min-width:300px" />
        <input id="password" placeholder="密码（先在控制台给该用户设置）" type="password" style="min-width:220px" />
        <button id="loginPw">邮箱+密码登录</button>
      </div>
      <div id="authStatus" class="muted" style="margin-top:6px"></div>
    </div>

    <div id="admin" class="card" style="display:none">
      <h2>商品管理</h2>
      <div class="row">
        <button id="refresh">刷新商品列表</button>
      </div>
      <table>
        <thead><tr><th>标题(EN)</th><th>分类</th><th>价格(HKD分)</th><th>库存</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
let supabase

function initClient(){
  const url = document.getElementById('supabaseUrl').value.trim()
  const anon = document.getElementById('supabaseAnon').value.trim()
  if(!url || !anon) return alert('请先填入 SUPABASE_URL 与 SUPABASE_ANON_KEY')
  supabase = window.supabase.createClient(url, anon)
  return supabase
}

async function loginPw(){
  if(!initClient()) return
  const email = document.getElementById('email').value.trim()
  const password = document.getElementById('password').value
  if(!email || !password) return alert('请输入邮箱与密码')
  const { data, error } = await supabase.auth.signInWithPassword({ email, password })
  document.getElementById('authStatus').textContent = error ? ('登录失败：' + error.message) : '登录成功，正在读取权限…'
  if(!error) await checkRole()
}

async function checkRole(){
  const { data: { user } } = await supabase.auth.getUser()
  if(!user) return
  const { data, error } = await supabase.from('profiles').select('role').eq('id', user.id).single()
  if(error){ document.getElementById('authStatus').textContent = '读取角色失败：'+error.message; return }
  if(data?.role === 'admin'){ document.getElementById('admin').style.display = 'block'; loadProducts() }
  else { document.getElementById('authStatus').textContent = '当前账户非管理员，无法访问 /admin' }
}

async function loadProducts(){
  const { data, error } = await supabase.from('products').select('id,title_en,price_cents,category_id')
  if(error){ alert('读取商品失败：'+error.message); return }
  const tbody = document.getElementById('tbody'); tbody.innerHTML = ''
  for(const p of data){
    // fetch inventory
    let stock = ''
    const { data: inv } = await supabase.from('inventory').select('stock').eq('product_id', p.id).maybeSingle()
    stock = inv?.stock ?? ''
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${p.title_en||''}</td><td>${p.category_id||''}</td><td>${p.price_cents||''}</td><td>${stock}</td>`
    tbody.appendChild(tr)
  }
}

document.getElementById('loginPw').onclick = loginPw
document.getElementById('refresh').onclick = loadProducts
</script>
</body>
</html>
